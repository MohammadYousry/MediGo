<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بطاقة MediGO الطارئة</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #26A69A;
            padding-bottom: 15px;
        }
        .header img.logo {
            max-width: 150px;
            margin-bottom: 10px;
        }
        .header h1 {
            color: #26A69A;
            margin: 0;
            font-size: 1.8em;
        }
        .profile-pic-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .profile-pic {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #26A69A;
            object-fit: cover;
            background-color: #e0e0e0;
        }
        .section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .section h2 {
            color: #004D40;
            font-size: 1.4em;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #B2DFDB;
            padding-bottom: 5px;
        }
        .info-item {
            margin-bottom: 8px;
        }
        .info-item strong {
            display: inline-block;
            width: 150px;
            color: #555;
        }
        .list {
            list-style: none;
            padding-right: 0;
        }
        .list li {
            background-color: #e8f5e9;
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 6px;
            border-right: 4px solid #26A69A;
        }
        .emergency-contact {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: #fff;
        }
        #loading-message, #error-message {
            text-align: center;
            font-size: 1.2em;
            padding: 20px;
            color: #777;
        }
        #error-message {
            color: #D32F2F;
        }
        .text-danger { color: #D32F2F; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="medi go logo.png" alt="MediGO Logo" class="logo"/>
            <h1>بطاقة معلومات طارئة</h1>
        </div>

        <div id="loading-message">جاري تحميل بيانات المريض...</div>
        <div id="error-message" style="display:none;"></div>
        
        <div id="patient-info-content" style="display:none;">
            <div class="profile-pic-container">
                <img id="profile_photo" src="" alt="الصورة الشخصية" class="profile-pic">
            </div>
            <div class="section">
                <h2>المعلومات الشخصية</h2>
                <div class="info-item"><strong>الاسم الكامل:</strong> <span id="full_name"></span></div>
                <div class="info-item"><strong>العمر:</strong> <span id="age"></span></div>
                <div class="info-item"><strong>تاريخ الميلاد:</strong> <span id="date_of_birth"></span></div>
                <div class="info-item"><strong>النوع:</strong> <span id="gender"></span></div>
                <div class="info-item"><strong>فصيلة الدم:</strong> <span id="blood_type" class="text-danger"></span></div>
                <div class="info-item"><strong>الرقم القومي:</strong> <span id="national_id"></span></div>
                <div class="info-item"><strong>رقم الهاتف:</strong> <span id="phone_number"></span></div>
                <div class="info-item"><strong>العنوان:</strong> <span id="address"></span></div>
            </div>
            <div class="section" id="chronic-diseases-section">
                <h2>الأمراض المزمنة</h2>
                <ul id="chronic_diseases_list" class="list"></ul>
            </div>
            <div class="section" id="allergies-section">
                <h2>الحساسية</h2>
                <ul id="allergies_list" class="list"></ul>
            </div>
            <div class="section" id="medications-section">
                <h2>الأدوية الحالية</h2>
                <ul id="medications_list" class="list"></ul>
            </div>
            <div class="section" id="emergency-contacts-section">
                <h2>جهات اتصال الطوارئ</h2>
                <div id="emergency_contacts_list"></div>
            </div>
        </div>
    </div>

    <script>
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function displayData(data) {
            console.log("[displayData] Received data:", data); // <-- DEBUG: Log received data
            if (!data || !data.user_info) {
                console.error("[displayData] Error: data or data.user_info is missing.", data); // <-- DEBUG
                showError("لم يتم العثور على بيانات المستخدم أو أن هيكل البيانات غير متوقع.");
                return;
            }
            const userInfo = data.user_info;
            console.log("[displayData] Processing userInfo:", userInfo); // <-- DEBUG

            document.getElementById('profile_photo').src = userInfo.profile_picture_url || 'medi go logo.png';
            document.getElementById('profile_photo').alt = userInfo.full_name || 'الصورة الشخصية';
            
            document.getElementById('full_name').textContent = userInfo.full_name || 'غير متوفر';
            document.getElementById('age').textContent = userInfo.age !== undefined ? userInfo.age : 'غير متوفر';
            document.getElementById('date_of_birth').textContent = userInfo.date_of_birth || 'غير متوفر';
            document.getElementById('gender').textContent = userInfo.gender || 'غير متوفر';
            document.getElementById('blood_type').textContent = userInfo.blood_type || 'غير متوفر';
            document.getElementById('national_id').textContent = userInfo.national_id || 'غير متوفر';
            document.getElementById('phone_number').textContent = userInfo.phone_number || 'غير متوفر';
            
            let fullAddress = [];
            if(userInfo.address) fullAddress.push(userInfo.address);
            if(userInfo.city) fullAddress.push(userInfo.city);
            if(userInfo.region) fullAddress.push(userInfo.region);
            document.getElementById('address').textContent = fullAddress.length > 0 ? fullAddress.join(', ') : 'غير متوفر';

            const diseasesList = document.getElementById('chronic_diseases_list');
            diseasesList.innerHTML = ''; // Clear previous items
            if (userInfo.chronic_diseases && userInfo.chronic_diseases.length > 0) {
                document.getElementById('chronic-diseases-section').style.display = 'block';
                userInfo.chronic_diseases.forEach(disease => {
                    const li = document.createElement('li');
                    li.textContent = disease;
                    diseasesList.appendChild(li);
                });
            } else {
                document.getElementById('chronic-diseases-section').style.display = 'none';
            }

            const allergiesList = document.getElementById('allergies_list');
            allergiesList.innerHTML = ''; // Clear previous items
            if (userInfo.allergies && userInfo.allergies.length > 0) {
                document.getElementById('allergies-section').style.display = 'block';
                userInfo.allergies.forEach(allergy => {
                    const li = document.createElement('li');
                    li.textContent = `${allergy.allergen} (رد الفعل: ${allergy.reaction || 'غير محدد'}, الشدة: ${allergy.severity || 'غير محددة'})`;
                    allergiesList.appendChild(li);
                });
            } else {
                document.getElementById('allergies-section').style.display = 'none';
            }
            
            const medicationsList = document.getElementById('medications_list');
            medicationsList.innerHTML = ''; // Clear previous items
            if (userInfo.medications && userInfo.medications.length > 0) {
                document.getElementById('medications-section').style.display = 'block';
                userInfo.medications.forEach(med => {
                    const li = document.createElement('li');
                    li.textContent = `${med.name} (الجرعة: ${med.dosage || 'غير محددة'}, التكرار: ${med.frequency || 'غير محدد'})`;
                    medicationsList.appendChild(li);
                });
            } else {
                document.getElementById('medications-section').style.display = 'none';
            }

            const contactsDiv = document.getElementById('emergency_contacts_list');
            contactsDiv.innerHTML = ''; // Clear previous items
            if (userInfo.emergency_contacts && userInfo.emergency_contacts.length > 0) {
                document.getElementById('emergency-contacts-section').style.display = 'block';
                userInfo.emergency_contacts.forEach(contact => {
                    const contactEl = document.createElement('div');
                    contactEl.className = 'emergency-contact';
                    contactEl.innerHTML = `<strong>${contact.name || 'غير متوفر'}</strong><br>
                                           العلاقة: ${contact.relationship || 'غير محددة'}<br>
                                           الهاتف: <a href="tel:${contact.phone_number || ''}">${contact.phone_number || 'غير متوفر'}</a>`;
                    contactsDiv.appendChild(contactEl);
                });
            } else {
                document.getElementById('emergency-contacts-section').style.display = 'none';
            }
            
            document.getElementById('loading-message').style.display = 'none';
            document.getElementById('error-message').style.display = 'none'; // Hide error message if data is displayed
            document.getElementById('patient-info-content').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loading-message').style.display = 'none';
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('patient-info-content').style.display = 'none'; // Hide content on error
        }

        async function loadPatientData() {
            // --- أسطر جديدة للطباعة والتأكد ---
            console.log("Page loaded. Attempting to extract user_id from URL.");
            const userId = getQueryParam('user_id');
            console.log("Extracted user_id:", userId);
            // ---------------------------------
            
            if (!userId) {
                console.error("User ID is missing or empty in the URL!");
                showError('لم يتم تحديد معرّف المستخدم في الرابط. برجاء التأكد من أن الرابط يحتوي على ?user_id=SOME_ID');
                return;
            }

            console.log(`Fetching data for user_id: ${userId}`);
            const apiBaseUrl = 'http://127.0.0.1:8000'; 
            const apiUrl = `https://medigo.onrender.com/qrcode/${userId}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: { 'accept': 'application/json' }
                });
                
                console.log("API Response Status:", response.status); // <-- DEBUG: Log status

                if (response.ok) {
                    const data = await response.json();
                    console.log("API Response Data (raw):", data); // <-- DEBUG: Log raw data
                    displayData(data); 
                } else {
                    const errorText = await response.text(); // Get error as text first
                    console.error("API Error Response Text:", errorText); // <-- DEBUG
                    let errorDetail = `الحالة: ${response.status}`;
                    try {
                        const errorData = JSON.parse(errorText); // Try to parse as JSON
                        if (errorData && errorData.detail) {
                            errorDetail = `${errorData.detail} (الحالة: ${response.status})`;
                        }
                    } catch (e) {
                        // Not a JSON error, use the text itself if not too long
                        if(errorText.length < 200) errorDetail += ` - ${errorText}`;
                    }

                    if (response.status === 404) {
                        showError('لم يتم العثور على بيانات QR Code لهذا المستخدم.');
                    } else {
                        showError(`خطأ في جلب البيانات: ${errorDetail}`);
                    }
                }
            } catch (error) {
                console.error('General Fetch error:', error);
                showError('حدث خطأ أثناء الاتصال بالخادم. برجاء التأكد من أن السيرفر المحلي (py main.py) يعمل وأن الرابط صحيح.');
            }
        }
        window.onload = loadPatientData;
    </script>
</body>
</html>