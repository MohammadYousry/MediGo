<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="بطاقة طوارئ طبية فورية من MediGO تعرض بيانات المريض بشكل منسق وسريع.">
  <meta http-equiv="Content-Language" content="ar">
  <title>بطاقة طوارئ المريض | MediGO</title>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(to right, #e0f7fa, #f1f8e9);
      margin: 0;
      padding: 20px;
      direction: rtl;
    }
    .container {
      max-width: 850px;
      background-color: white;
      margin: auto;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .logo {
      display: block;
      max-width: 130px;
      margin: auto;
    }
    .profile-img {
      display: block;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 10px auto;
      object-fit: cover;
      border: 2px solid #00796b;
    }
    h1 {
      color: #00695c;
      text-align: center;
      margin: 10px 0 30px;
    }
    .section {
      margin-bottom: 25px;
    }
    .section h2 {
      color: #00796b;
      border-bottom: 1px solid #b2dfdb;
      padding-bottom: 6px;
      margin-bottom: 12px;
      font-size: 1.3em;
    }
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      row-gap: 10px;
      column-gap: 10px;
    }
    .info-label {
      color: #444;
      font-weight: bold;
    }
    .info-value {
      color: #222;
    }
    .pill {
      display: inline-block;
      background: #e0f2f1;
      border-right: 4px solid #00796b;
      padding: 6px 10px;
      margin: 4px;
      border-radius: 5px;
    }
    .emergency-contact {
      background: #ffebee;
      padding: 10px;
      border: 1px solid #ef9a9a;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .empty {
      color: #aaa;
      font-style: italic;
    }
    #loading-text {
      text-align: center;
      color: #888;
      font-size: 1.1em;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://medigo-eg.netlify.app/medi_go_logo.png" alt="MediGO Logo" class="logo">
    <img id="profile_photo" class="profile-img" src="" alt="الصورة الشخصية">
    <h1>بطاقة طوارئ المريض</h1>
    <p id="loading-text">جاري تحميل البيانات...</p>

    <div class="section">
      <h2>المعلومات الشخصية</h2>
      <div class="info-grid">
        <div class="info-label">الاسم:</div><div class="info-value" id="full_name">جاري التحميل...</div>
        <div class="info-label">العمر:</div><div class="info-value" id="age"></div>
        <div class="info-label">النوع:</div><div class="info-value" id="gender"></div>
        <div class="info-label">فصيلة الدم:</div><div class="info-value" id="blood_type"></div>
        <div class="info-label">الرقم القومي:</div><div class="info-value" id="national_id"></div>
        <div class="info-label">الهاتف:</div><div class="info-value" id="phone_number"></div>
        <div class="info-label">العنوان:</div><div class="info-value" id="address"></div>
      </div>
    </div>

    <div class="section"><h2>الأمراض المزمنة</h2><div id="chronic_diseases_list" class="info-value empty">لا توجد بيانات</div></div>
    <div class="section"><h2>الأدوية</h2><div id="medications_list" class="info-value empty">لا توجد بيانات</div></div>
    <div class="section"><h2>الحساسية</h2><div id="allergies_list" class="info-value empty">لا توجد بيانات</div></div>
    <div class="section"><h2>نتائج التحاليل</h2><div id="biomarkers_list" class="info-value empty">لا توجد بيانات</div></div>
    <div class="section"><h2>ضغط الدم</h2><div class="info-label">المرحلة:</div><div class="info-value" id="bp_stage">لا توجد بيانات</div></div>
    <div class="section"><h2>العمليات الجراحية</h2><div id="surgeries_list" class="info-value empty">لا توجد بيانات</div></div>
    <div class="section"><h2>الأشعة</h2><div id="radiology_list" class="info-value empty">لا توجد بيانات</div></div>
    <div class="section"><h2>جهات اتصال الطوارئ</h2><div id="emergency_contacts_list" class="info-value empty">لا توجد بيانات</div></div>
  </div>

  <script>
    async function loadPatientData() {
      const userId = new URLSearchParams(window.location.search).get('user_id');
      if (!userId) return;

      document.getElementById("loading-text").style.display = "block";

      try {
        const response = await fetch(`https://medigo.onrender.com/qrcode/${userId}`);
        if (!response.ok) throw new Error("Failed to fetch");

        const data = await response.json();
        const user = data.user_info;

        const profile = document.getElementById('profile_photo');
        profile.src = user.profile_picture_url || "https://medigo-eg.netlify.app/medi_go_logo.png";
        profile.onerror = () => {
          profile.src = "https://medigo-eg.netlify.app/medi_go_logo.png";
        };

        document.getElementById('full_name').textContent = user.full_name || 'غير متوفر';
        document.getElementById('age').textContent = user.age || 'غير متوفر';
        document.getElementById('gender').textContent = user.gender || 'غير متوفر';
        document.getElementById('blood_type').textContent = user.blood_type || 'غير متوفر';
        document.getElementById('national_id').textContent = user.national_id || 'غير متوفر';
        document.getElementById('phone_number').textContent = user.phone_number || 'غير متوفر';
        document.getElementById('address').textContent = [user.address, user.city, user.region].filter(Boolean).join(', ') || 'غير متوفر';

        const renderList = (id, items, format) => {
          const el = document.getElementById(id);
          if (items?.length) {
            el.classList.remove('empty');
            el.innerHTML = items.map(format).join('');
          }
        };

        renderList("chronic_diseases_list", user.chronic_diseases, d => `<span class="pill">${d}</span>`);
        renderList("medications_list", user.medications, m => `<span class="pill">${m.name} (${m.dosage || ''}, ${m.frequency || ''})</span>`);
        renderList("allergies_list", user.allergies, a => `<span class="pill">${a.allergen} - ${a.reaction || ''}</span>`);
        renderList("biomarkers_list", user.biomarkers, b => `<span class="pill">${b.test_name}: ${b.value} ${b.unit || ''}</span>`);
        renderList("surgeries_list", user.surgeries, s => `<span class="pill">${s.name || 'عملية'} - ${s.date || ''}</span>`);
        renderList("radiology_list", user.radiology, r => `<span class="pill">${r.test_type || 'نوع'} - ${r.result || ''}</span>`);

        document.getElementById('bp_stage').textContent = user.hypertension_stage || 'غير متوفر';

        const contactContainer = document.getElementById('emergency_contacts_list');
        if (user.emergency_contacts?.length) {
          contactContainer.classList.remove('empty');
          contactContainer.innerHTML = user.emergency_contacts.map(c => `
            <div class="emergency-contact">
              <strong>${c.name || 'غير معروف'}</strong><br>
              العلاقة: ${c.relationship || 'غير محددة'}<br>
              الهاتف: <a href="tel:${c.phone_number || ''}">${c.phone_number || 'غير متوفر'}</a>
            </div>
          `).join('');
        }

      } catch (error) {
        console.error("Fetch error:", error);
        const errorText = "⚠️ تعذر تحميل البيانات.";
        [
          'full_name', 'age', 'gender', 'blood_type', 'national_id', 'phone_number', 'address',
          'chronic_diseases_list', 'medications_list', 'allergies_list',
          'biomarkers_list', 'surgeries_list', 'radiology_list',
          'bp_stage', 'emergency_contacts_list'
        ].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.textContent = errorText;
            el.classList.add("empty");
          }
        });
      } finally {
        document.getElementById("loading-text").style.display = "none";
      }
    }

    window.onload = loadPatientData;
  </script>
</body>
</html>
