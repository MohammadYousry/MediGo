<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>بطاقة الطوارئ - MediGO</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(to bottom, #e0f7fa, #ffffff);
      margin: 0;
      padding: 20px;
      color: #004d40;
      text-align: right;
    }

    .card {
      background-color: #ffffff;
      border-radius: 16px;
      padding: 24px;
      max-width: 720px;
      margin: auto;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.15);
    }

    .logo {
      display: block;
      margin: 0 auto 10px;
      max-width: 120px;
    }

    .title {
      text-align: center;
      font-size: 1.6em;
      margin-bottom: 20px;
      color: #00796b;
      font-weight: 700;
    }

    .profile-img {
      display: block;
      margin: 0 auto 20px;
      border-radius: 50%;
      width: 120px;
      height: 120px;
      object-fit: cover;
      border: 3px solid #00796b;
      background-color: #eee;
    }

    .section {
      margin-bottom: 20px;
    }

    .section-title {
      font-weight: 700;
      font-size: 1.2em;
      margin-bottom: 10px;
      border-bottom: 2px solid #80cbc4;
      padding-bottom: 5px;
    }

    .info-item {
      margin-bottom: 8px;
    }

    .info-item strong {
      display: inline-block;
      width: 140px;
      color: #00695c;
    }

    .list {
      background-color: #e0f2f1;
      padding: 10px;
      border-radius: 8px;
    }

    .error {
      color: red;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="card">
    <img src="medi go logo.png" alt="شعار MediGO" class="logo" />
    <div class="title">بطاقة معلومات طارئة</div>

    <img id="profile_photo" src="" class="profile-img" alt="الصورة الشخصية" onerror="this.src='https://via.placeholder.com/120?text=No+Image'; this.alt='لا تتوفر صورة';" />

    <div class="section">
      <div class="section-title">المعلومات الشخصية</div>
      <div class="info-item"><strong>الاسم الكامل:</strong> <span id="full_name"></span></div>
      <div class="info-item"><strong>العمر:</strong> <span id="age"></span></div>
      <div class="info-item"><strong>النوع:</strong> <span id="gender"></span></div>
      <div class="info-item"><strong>الرقم القومي:</strong> <span id="national_id"></span></div>
      <div class="info-item"><strong>فصيلة الدم:</strong> <span id="blood_type"></span></div>
      <div class="info-item"><strong>الهاتف:</strong> <span id="phone_number"></span></div>
      <div class="info-item"><strong>العنوان:</strong> <span id="address"></span></div>
    </div>

    <div class="section">
      <div class="section-title">الأمراض المزمنة</div>
      <ul id="chronic_diseases_list" class="list"></ul>
    </div>

    <div class="section">
      <div class="section-title">الحساسية</div>
      <ul id="allergies_list" class="list"></ul>
    </div>

    <div class="section">
      <div class="section-title">الأدوية الحالية</div>
      <ul id="medications_list" class="list"></ul>
    </div>

    <div class="section">
      <div class="section-title">جهات اتصال الطوارئ</div>
      <ul id="emergency_contacts_list" class="list"></ul>
    </div>
  </div>

  <script>
    const userId = new URLSearchParams(window.location.search).get("user_id");
    const api = `https://medigo.onrender.com/qrcode/${userId}`;

    fetch(api)
      .then(res => res.json())
      .then(data => {
        const u = data.user_info;
        document.getElementById("profile_photo").src = u.profile_picture_url || '';
        document.getElementById("full_name").textContent = u.full_name || 'غير متوفر';
        document.getElementById("age").textContent = u.age || 'غير متوفر';
        document.getElementById("gender").textContent = u.gender || 'غير متوفر';
        document.getElementById("national_id").textContent = u.national_id || 'غير متوفر';
        document.getElementById("blood_type").textContent = u.blood_type || 'غير متوفر';
        document.getElementById("phone_number").textContent = u.phone_number || 'غير متوفر';
        document.getElementById("address").textContent = `${u.address || ''} ${u.city || ''} ${u.region || ''}`.trim();

        const chronic = document.getElementById("chronic_diseases_list");
        u.chronic_diseases?.forEach(d => chronic.innerHTML += `<li>${d}</li>`);

        const allergies = document.getElementById("allergies_list");
        u.allergies?.forEach(a => allergies.innerHTML += `<li>${a.allergen} (رد الفعل: ${a.reaction || 'غير محدد'}, الشدة: ${a.severity || 'غير محددة'})</li>`);

        const meds = document.getElementById("medications_list");
        u.medications?.forEach(m => meds.innerHTML += `<li>${m.name} - ${m.dosage || '؟'} × ${m.frequency || '؟'}</li>`);

        const contacts = document.getElementById("emergency_contacts_list");
        u.emergency_contacts?.forEach(c => contacts.innerHTML += `<li><strong>${c.name}</strong> (${c.relationship}) - ${c.phone_number}</li>`);
      })
      .catch(err => {
        document.body.innerHTML = `<div class="error">تعذر تحميل البيانات. تأكد من وجود اتصال بالإنترنت وصحة معرف المستخدم.</div>`;
      });
  </script>
</body>
</html>
